### 一、**成本函数的核心作用**

在机器人运动规划中，**成本函数**用于量化轨迹的 “优劣”，引导算法生成满足特定约束（如避障、平滑性）的解。EDMP 的创新在于：

1. **结合扩散模型的先验学习**：用扩散模型预学习合法轨迹的分布（如关节运动范围、无自碰撞）。
2. **推理期动态引导**：在扩散的反向去噪过程中，实时计算场景特定成本的梯度，调整轨迹方向。
3. **多成本集合**：并行使用多个成本函数，覆盖不同场景需求，提升泛化性。

### 二、**核心成本函数详解**

#### 1. **交集体积成本（Intersection Volume Cost, $J_{inter}$）**

- **物理意义**： 计算机械臂连杆与障碍物的实时碰撞体积，强制轨迹远离障碍物。
- **数学定义**： 对机械臂每个连杆 i 和每个时间步 k，用正向运动学（FK）计算连杆在场景中的位置，与障碍物的交集体积之和：\(J_{inter}(\tau, E) = \sum_{k=0}^{h-1} \sum_{i=0}^{m-1} V(FK(s_k[i]), E)\) 其中 \(V(A, B)\) 表示物体 A（连杆）与 B（障碍物）的交集体积，通过包围盒（如轴对齐包围盒 AABB）计算。
- **梯度作用**： 梯度 \(\nabla J_{inter}\) 指向碰撞最深的方向，引导连杆沿反方向移动，脱离障碍物（如图 5a 红色箭头）。
- **适用场景**：静态障碍物规避，如机械臂绕过桌面上的固定盒子。

#### 2. **扫掠体积成本（Swept Volume Cost, $J_{swept}$）**

- **物理意义**： 计算相邻轨迹点间连杆运动扫过的体积，避免运动过程中动态碰撞（如机械臂挥动时扫到障碍物）。
- **数学定义**： 对相邻时间步 k 和 \(k+1\)，计算连杆 i 移动扫过的体积与障碍物的交集：$J_{swept}(\tau, E) = \sum_{k=0}^{h-2} \sum_{i=0}^{m-1} V(SV(s_k[i], s_{k+1}[i]), E)$ 其中 $SV(s_k[i], s_{k+1}[i])$ 是连杆从 $s_k[i]$ 到 $s_{k+1}[i]$ 的扫掠体积。
- **梯度作用**： 梯度 $\nabla J_{swept}$ 惩罚轨迹中相邻点间的潜在碰撞，迫使轨迹平滑绕行（如图 5b 红色箭头）。
- **适用场景**：狭窄通道或动态障碍物（如机械臂穿过密集货架），避免 “卡壳”。

#### 3. **其他辅助成本函数**

- **关节限制成本（Joint Limits Cost）**： 惩罚超出关节运动范围的轨迹点：$c_{\text{limits}}(q_i) =   \begin{cases}   (q_{\text{min}} + \epsilon - q_i)^2 & \text{if } q_i < q_{\text{min}} + \epsilon \\  0 & \text{if } q_{\text{min}}+\epsilon \leq q_i \leq q_{\text{max}}-\epsilon \\  (q_{\text{max}} - \epsilon - q_i)^2 & \text{otherwise}  \end{cases}$ 其中 $\epsilon$ 是安全 margin，避免关节达到物理极限。
- **路径长度成本（Path Length Cost）**： 最小化轨迹总长度，鼓励短路径：$J_{\text{length}}(\tau) = \sum_{k=0}^{h-2} \| s_{k+1} - s_k \|_2$
- **末端姿态成本（End-effector Pose Cost）**： 在持物任务中，保持末端执行器姿态恒定（如抓取时保持物体水平）：$J_{\text{ee}}(\tau) = \sum_{k=0}^{h-1} d_{\text{SE(3)}}(T(q[k]), T_g[k])$其中 $d_{\text{SE(3)}}$ 是 SE (3) 空间的姿态距离（平移 + 旋转误差）。

### 三、**为什么需要多成本函数？单一成本的局限**

#### 1. **场景多样性导致单一成本失效**

- **示例 1**：仅用交集体积成本在窄通道场景中可能无法引导机械臂先缩回再前进（如图 4a），而扫掠体积成本结合障碍物膨胀（Obstacle Expansion）可迫使轨迹先退避（图 4b）。
- **示例 2**：路径长度成本在开阔场景有效，但在复杂障碍物中可能导致碰撞，需结合交集体积成本。

#### 2. **多成本互补提升鲁棒性**

- **并行优化**：EDMP 同时运行 12 个成本函数（5 个交集 + 7 个扫掠），每个成本关注不同约束，生成多组候选轨迹（如图 3）。
- **动态选择**：推理结束后选择总成本最低的轨迹，确保解既避障又高效（算法 1 步骤 5）。

### 四、**成本函数如何与扩散模型结合？**

#### 1. **训练阶段：学习无约束先验**

扩散模型在训练时不依赖具体场景成本，仅学习合法轨迹的通用特征（如关节平滑性、自碰撞规避）。此时损失函数为纯 MSE，不涉及 $J_{inter}$ 等场景成本。

#### 2. **推理阶段：成本梯度引导去噪**

在反向扩散的每一步 t，对每个成本函数 $J_i$，计算其梯度并叠加到去噪均值上：$\tau_{t-1}^* = \mu_\theta(\tau_t, t) - \alpha_t \nabla J_i(\tau_t)$ 其中 $\mu_\theta(\tau_t, t)$ 是扩散模型预测的去噪方向，$\alpha_t$ 是随时间递减的学习率（后期更关注成本细节）。

### 五、**实验验证：多成本的有效性**

#### 1. **成功率提升**

- 在 Hybrid 场景中，EDMP 使用 12 成本集合的成功率达 86.13%，远超单一成本平均（79.25%），见表 III。
- 随成本数量增加，成功率渐近提升（图 7），证明多成本覆盖更多场景特征。

#### 2. **泛化性增强**

- 在未见场景（如机械臂持物避障）中，EDMP 通过新增 “物体 - 环境碰撞成本” 即可适应，无需重训，成功率 80% 以上（图 6），而深度学习方法（如 MπNets）需重新收集数据。

### 六、**总结：成本函数的设计逻辑**

EDMP 的成本函数设计遵循以下原则：

1. **几何可微性**：基于包围盒和正向运动学，确保梯度可计算（如 GJK/EPA 算法），适合实时优化。
2. **场景解耦**：将通用约束（关节限制）与场景特定约束（碰撞体积）分离，便于快速扩展新成本（如抓取姿态成本）。
3. **多样性优先**：通过多成本并行引导，生成覆盖不同优化目标的轨迹，供下游任务选择（如最短路径或最安全路径）。

通过这种设计，EDMP 既保留了扩散模型的生成能力，又通过经典成本函数弥补了深度学习的泛化短板，成为连接数据驱动与模型驱动的桥梁。