### 一、核心思想：用扩散模型 “学习轨迹的噪声 - 去噪规律”

- **核心假设**： 无碰撞轨迹可以看作是从 “纯噪声” 逐步去噪得到的高质量数据（类似图像生成中的扩散过程）。
- **创新点**： 将运动规划转化为 **扩散模型的反向去噪过程**，同时引入任务目标（如避障、到达终点）作为引导信号，确保生成轨迹符合物理约束。

### 二、训练阶段：让扩散模型学会 “轨迹生成”

#### 1. **数据准备：用专家轨迹训练扩散模型**

- 专家轨迹来源：

  使用传统规划器（如 RRTConnect）生成高质量无碰撞轨迹，涵盖多种环境（2D/3D 导航、7 自由度机械臂）。

  - 例如：在 Panda Shelf 环境中，收集机械臂在有障碍物场景中的避障轨迹。

- **数据格式**： 轨迹表示为状态序列 $\tau = (s_0, s_1, ..., s_H)$，其中 $s_t = [q_t, \dot{q}_t]$ 包含关节位置和速度（共 14 维状态）。

#### 2. **正向扩散过程：给轨迹加噪声**

- 逐步破坏轨迹：

  从真实轨迹$\tau_0$开始，通过马尔可夫链逐步添加高斯噪声，生成噪声轨迹$\tau_t$。

  - 数学描述：$\tau_t = \sqrt{\bar{\alpha}_t}\tau_0 + \sqrt{1-\bar{\alpha}_t}\epsilon$，其中 $\epsilon \sim \mathcal{N}(0, I)$，$\bar{\alpha}_t$ 是噪声调度参数。

- **目标**：让模型学习 “如何从噪声中恢复真实轨迹”。

#### 3. **反向去噪训练：学习轨迹重建**

- **模型架构**： 使用 **时序 U-Net** 作为扩散模型，输入噪声轨迹 $\tau_t$ 和时间步 t，输出预测噪声 $\hat{\epsilon}$。
- **损失函数**： 均方误差（MSE）衡量预测噪声与真实噪声的差异：$\mathcal{L}(\theta) = \mathbb{E}_{t,\epsilon,\tau_0} \left\| \epsilon - \epsilon_\theta(\tau_t, t) \right\|_2^2$
- **训练目标**：通过反向传播优化模型参数 $\theta$，使其能准确预测去噪方向。

### 三、推理阶段：结合任务目标生成定制化轨迹

#### 1. **规划即推理：将任务目标融入扩散采样**

- 任务目标表示：

  用成本函数$c_i(\tau)$描述任务要求，如：

  - 起点 / 终点约束（$c_{start/goal}$）：强制轨迹首尾为指定状态。
  - 碰撞成本（$c_{obs}$）：基于符号距离函数（SDF），避免机器人与障碍物碰撞。
  - 平滑度成本（$c_{GP}$）：利用高斯过程先验，确保轨迹平滑。

- **后验分布**： 将运动规划转化为后验采样问题：$p(\tau | \mathcal{O}) \propto p(\tau) \cdot \exp\left(-\sum_i \lambda_i c_i(\tau)\right)$ 其中 $p(\tau)$ 是扩散模型学习的轨迹先验，$\mathcal{O}$ 是任务目标，$\lambda_i$是成本权重。

#### 2. **带引导的反向去噪：生成符合目标的轨迹**

- **初始化**： 从纯噪声轨迹 $\tau_N \sim \mathcal{N}(0, I)$ 开始，并固定首尾状态为任务指定的起点 $s_s$ 和终点 $s_g$。

- 迭代去噪：

  从$t=N$到$t=1$

   迭代执行以下步骤：

  1. **预测去噪方向**：使用扩散模型计算当前噪声轨迹的去噪均值 $\mu_t$。
  2. **计算成本梯度**：根据任务成本函数，计算梯度 $g = -\sum_i \lambda_i \nabla_{\tau_{t-1}} c_i(\mu_t)$，引导轨迹向低成本区域移动。
  3. **更新轨迹**：结合去噪均值和成本梯度，生成新轨迹：$\tau_{t-1} = \mu_t + g + \sigma_t z \quad (z \sim \mathcal{N}(0, I))$ 其中 $\sigma_t$是噪声标准差，控制探索与利用的平衡。

- **输出**：迭代结束后得到的轨迹 $\tau_0$即为无碰撞、符合目标的运动计划。

### 四、关键技术细节

#### 1. **多模态轨迹生成**

- 扩散模型天然支持多模态输出，通过调整引导强度（如成本权重 $\lambda_i$），可生成不同风格的轨迹（如最短路径 vs. 最平滑路径）。
- 实验表明，MPD 生成的轨迹方差（VAR）高于 CVAE 等基线模型，说明其多样性更强。

#### 2. **物理约束嵌入**

- **碰撞规避**：通过碰撞成本 $c_{obs}$ 的梯度引导，在去噪过程中实时调整轨迹，避免进入障碍物区域。
- **关节限制**：通过关节限制成本 $c_{limits}$，确保生成的关节角度在物理可行范围内。

#### 3. **计算效率**

- 推理阶段的主要计算成本来自成本函数的梯度计算（如 SDF 的微分），而扩散采样本身可并行化（GPU 加速），因此在高维场景（如 7 自由度机械臂）中仍保持高效。

### 五、实验验证：从模拟到真实机器人

#### 1. **模拟环境测试**

- 场景：
  - 2D/3D 导航（PointMass）：验证避障和路径优化能力。
  - 7 自由度机械臂（Panda Spheres/Shelf）：测试高维空间中的轨迹生成。
- 基线对比：
  - 传统方法：RRTConnect、GPMP（无先验）。
  - 生成模型：CVAE Prior/Posterior。
- 结果：
  - **成功率（S）**：MPD 在训练环境中成功率达 99%，在未见过的障碍物场景中仍达 79%，远超 CVAE（46%）。
  - **路径长度（PL）**：MPD 生成的轨迹比 RRTConnect 更短，平滑度更高（VAR 更低）。

#### 2. **真实机器人实验（Panda Shelf）**

- **任务**：机械臂在有新增障碍物的场景中移动瓶子，同时保持末端姿态恒定。
- 结果：
  - 采样 25 条轨迹，19 条无碰撞，证明 MPD 在真实环境中的泛化能力。
  - 失败案例主要源于碰撞模型的近似（使用球体而非精确几何）。

### 六、总结：MPD 的核心流程

1. 训练阶段：
   - 用专家轨迹训练扩散模型，学习 “噪声→轨迹” 的映射关系。
2. 推理阶段：
   - 从噪声开始，通过反向去噪和任务目标引导，生成定制化轨迹。
3. 优势：
   - **多模态性**：比 CVAE 更擅长捕捉轨迹多样性。
   - **泛化性**：在未见环境中表现稳健，适合复杂高维场景。
   - **效率**：比传统规划器更快，支持实时调整（如动态避障）。

**未来方向**：扩展至更复杂的机器人任务（如操作规划）、结合更精确的物理模型，以及提升在动态环境中的适应性。